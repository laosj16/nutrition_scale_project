<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- Remix Icon CDN -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¥å…»ç§¤æ¨¡å¼ - æ™ºèƒ½é£Ÿç‰©ç§¤ Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* åŸºæœ¬æ ·å¼ */
        body { font-family: 'Inter', sans-serif; overflow: hidden; background-color: #f0f0f0; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding-bottom: 80px; }
        .device-screen { width: 100%; max-width: 480px; aspect-ratio: 4 / 3; background-color: #1a1a1a; color: #e0e0e0; border-radius: 0.5rem; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        /* çŠ¶æ€æ  */
        .status-bar { display: flex; justify-content: space-between; align-items: center; padding: 8px 15px; background-color: rgba(0, 0, 0, 0.2); flex-shrink: 0; height: 36px; position: relative; }
        .status-bar > i { font-size: 18px; color: #e0e0e0; line-height: 1; flex-shrink: 0; }
        .status-bar > span#status-prompt { flex-grow: 1; text-align: center; font-size: 15px; color: #a0a0a0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin: 0 5px; }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 10px; position: relative; width: 100%; overflow: hidden; }
        
        /* é£Ÿç‰©é€‰æ‹©ç½‘æ ¼ */
        #food-selection { width: 100%; max-width: 460px; height: 280px; margin: 0 auto; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        #food-grid { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(2, 1fr); gap: 12px; width: 100%; max-width: 460px; height: 280px; padding: 15px; box-sizing: border-box; }
        .food-item { background-color: #333; border-radius: 6px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; font-size: 16px; padding: 12px; border: 2px solid transparent; transition: all 0.2s ease-out; cursor: default; overflow: hidden; }
        .food-item.selected { transform: scale(1.1); border-color: #3b82f6; background-color: #2563eb; z-index: 2; font-weight: bold; }
        .food-item i { font-size: 40px; color: inherit; transition: color 0.2s ease; }
        .food-item.selected i { color: #ffffff; }

        /* è¥å…»ä¿¡æ¯æ˜¾ç¤ºå®¹å™¨ */
        .nutrition-display { width: 100%; max-width: 95%; display: flex; flex-direction: column; align-items: center; height: 100%; overflow: hidden; padding: 0 4px; box-sizing: border-box; position: relative; }
        
        /* è¥å…»ä¿¡æ¯ç¿»é¡µå®¹å™¨ */
        #nutrition-pages-container { width: 100%; height: 100%; position: relative; }
        .nutrition-page {
            display: none; /* é»˜è®¤éšè—æ‰€æœ‰é¡µé¢ */
            flex-direction: column;
            /* ã€ä¿®æ”¹3ã€‘: æ”¹ä¸ºé¡¶éƒ¨å¯¹é½ */
            justify-content: flex-start;
            align-items: center;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            padding: 20px; /* å¢åŠ é¡¶éƒ¨å†…è¾¹è· */
            box-sizing: border-box;
            animation: fadeIn 0.5s ease;
        }
        .nutrition-page.visible {
            display: flex; /* åªæ˜¾ç¤ºå½“å‰é¡µé¢ */
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- é¡µé¢1: é‡é‡å’Œæ ¸å¿ƒèƒ½é‡ --- */
        .weight-energy-display { display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; gap: 20px; }
        .weight-section { display: inline-flex; flex-direction: row; align-items: baseline; justify-content: center; padding-bottom: 8px; border-bottom: 3px solid #60a5fa; }
        .weight-value { font-size: 75px; font-weight: 700; color: #ffffff; line-height: 1; margin-right: 12px; }
        .weight-unit { font-size: 32px; font-weight: 500; color: #a0a0a0; }
        .energy-section { display: flex; flex-direction: row; align-items: center; justify-content: space-around; gap: 30px; margin-top: 20px; }
        .energy-chart-container, .fat-chart-container { position: relative; width: 160px; height: 80px; }
        .energy-semicircle-bg, .fat-semicircle-bg { width: 100%; height: 100%; border: 12px solid rgba(255, 255, 255, 0.1); border-bottom: none; border-top-left-radius: 80px; border-top-right-radius: 80px; position: absolute; top: 0; left: 0; }
        .energy-semicircle-bg.color-high, .fat-semicircle-bg.color-high { border-color: #ef4444; }
        .energy-semicircle-bg.color-medium, .fat-semicircle-bg.color-medium { border-color: #fbbf24; }
        .energy-semicircle-bg.color-low, .fat-semicircle-bg.color-low { border-color: #60a5fa; }
        .energy-semicircle-bg.color-minimal, .fat-semicircle-bg.color-minimal { border-color: #34d399; }
        .energy-value-container, .fat-value-container { position: absolute; left: 50%; bottom: -10px; transform: translateX(-50%); text-align: center; z-index: 2; width: 100%; }
        .energy-percentage-label, .fat-percentage-label { font-size: 18px; font-weight: 700; }
        .energy-value-chart, .fat-value-chart { font-size: 28px; font-weight: 700; line-height: 1; }
        .energy-unit-chart, .fat-unit-chart { font-size: 14px; color: #a0a0a0; }
        .energy-name-label, .fat-name-label { position: absolute; bottom: -35px; left: 50%; transform: translateX(-50%); font-size: 20px; font-weight: 700; }
        .energy-value-chart, .energy-name-label { color: #60a5fa; }
        .fat-value-chart, .fat-name-label { color: #f59e0b; }

        /* --- é¡µé¢2, 3, 4: ä¸»è¦è¥å…»ç´  --- */
        .nutrition-section { width: 100%; max-width: 380px; }
        .section-title { font-size: 22px; font-weight: 600; color: #60a5fa; margin-bottom: 8px; text-align: center; border-bottom: 2px solid rgba(96, 165, 250, 0.3); padding-bottom: 6px; }
        .major-nutrients-container { border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.05); padding: 5px; margin-top: 8px; }
        .major-nutrient-item { padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; align-items: center; justify-content: space-between; font-size: 18px; }
        .major-nutrient-item:last-child { border-bottom: none; }
        .nutrient-name-container { display: flex; align-items: center; gap: 0.5rem; }
        .nutrient-name { color: #e0e0e0; }
        .nutrient-value-container { display: flex; align-items: baseline; gap: 4px; }
        .nutrient-value { color: #60a5fa; font-weight: 600; }
        .nutrient-unit { color: #a0a0a0; font-size: 0.8em; }
        .dv-percentage { font-size: 16px; font-weight: 600; margin-left: 10px; }
        .dv-high { color: #ef4444; } .dv-medium { color: #fbbf24; } .dv-low { color: #60a5fa; } .dv-minimal { color: #34d399; }
        .dv-explanation { font-size: 16px; color: #888; text-align: center; padding: 0; margin-top: 8px; font-style: italic; }

        /* --- é¡µé¢ 5-10: ç»´ç”Ÿç´ å’ŒçŸ¿ç‰©è´¨ --- */
        .nutrients-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; width: 100%; }
        .nutrient-mini-card { background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05)); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 14px 10px; text-align: center; min-height: 80px; display: flex; flex-direction: column; justify-content: center; position: relative; }
        .nutrient-mini-card .mini-name { font-size: 16px; color: #b0b0b0; margin-bottom: 4px; font-weight: 500; }
        .nutrient-mini-card .mini-value-container { font-size: 20px; color: #ffffff; font-weight: 700; }
        .nutrient-mini-card .mini-unit { font-size: 14px; color: #a0a0a0; }
        /* ã€ä¿®æ”¹4ã€‘: æ¢å¤ç™¾åˆ†æ¯”å¾½ç« æ ·å¼ */
        .mini-dv { position: absolute; top: 6px; right: 8px; font-size: 14px; font-weight: 600; padding: 2px 7px; border-radius: 4px; line-height: 1.1; min-width: 32px; text-align: center; box-shadow: 0 1px 4px rgba(0,0,0,0.10); background: rgba(255,255,255,0.10); }
        .vitamins-section .section-title { color: #34d399; border-color: rgba(52, 211, 153, 0.3); }
        .minerals-section .section-title { color: #fbbf24; border-color: rgba(251, 191, 36, 0.3); }
        
        /* ç»´ç”Ÿç´ é¡µé¢é¢œè‰²è®¾è®¡ */
        .vitamins-section .nutrient-mini-card { 
            background: linear-gradient(135deg, rgba(52, 211, 153, 0.15), rgba(52, 211, 153, 0.05)); 
            border: 1px solid rgba(52, 211, 153, 0.3); 
        }
        .vitamins-section .nutrient-mini-card .mini-name { color: #6ee7b7; }
        .vitamins-section .nutrient-mini-card .mini-value-container { color: #34d399; }
        .vitamins-section .nutrient-mini-card .mini-unit { color: #a7f3d0; }
        
        /* çŸ¿ç‰©è´¨é¡µé¢é¢œè‰²è®¾è®¡ */
        .minerals-section .nutrient-mini-card { 
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(251, 191, 36, 0.05)); 
            border: 1px solid rgba(251, 191, 36, 0.3); 
        }
        .minerals-section .nutrient-mini-card .mini-name { color: #fcd34d; }
        .minerals-section .nutrient-mini-card .mini-value-container { color: #fbbf24; }
        .minerals-section .nutrient-mini-card .mini-unit { color: #fde68a; }

        /* é€šç”¨ç»„ä»¶ */
        .tare-indicator { position: absolute; top: 10px; left: 10px; background-color: #007AFF; color: white; padding: 3px 8px; border-radius: 5px; font-size: 14px; font-weight: bold; opacity: 0; transition: opacity 0.2s ease-out; z-index: 5; }
        .tare-indicator.visible { opacity: 1; }
        .hidden { display: none !important; }

        /* é¡µé¢æŒ‡ç¤ºå™¨ */
        .page-indicator-container { display: flex; justify-content: center; align-items: center; padding: 8px 0; flex-shrink: 0; height: 24px; position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); z-index: 10; }
        .page-dot { width: 8px; height: 8px; background-color: #555; border-radius: 50%; margin: 0 4px; transition: background-color 0.3s ease, transform 0.3s ease; }
        .page-dot.active { background-color: #007AFF; transform: scale(1.2); }
        
        /* è¥å…»ä¿¡æ¯é¡µé¢æŒ‡ç¤ºå™¨ (å‚ç›´) */
        #nutrition-page-indicator { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; align-items: center; gap: 8px; z-index: 5; }
        #nutrition-page-indicator .page-dot { margin: 0; }

        /* æç¤ºæ  */
        .hint-bar { text-align: center; padding: 0 10px; background-color: rgba(0, 0, 0, 0.3); font-size: 15px; color: #b0b0b0; flex-shrink: 0; height: 32px; display: flex; align-items: center; justify-content: center; }
        .hint-bar.long-press-active { color: #ffffff; }
        @keyframes blink-text-animation { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .blink-text-inline { animation: blink-text-animation 1s infinite; font-weight: bold; }

        /* äº¤äº’æŒ‰é’® */
        .interaction-controls { position: fixed; bottom: 0; left: 0; width: 100%; background-color: rgba(240, 240, 240, 0.95); backdrop-filter: blur(5px); padding: 0.75rem 1rem; border-top: 1px solid #ccc; display: flex; justify-content: center; align-items: center; gap: 0.5rem; z-index: 100; }
        .control-button { padding: 0.5rem 1rem; font-size: 0.8rem; font-weight: 500; background-color: #4f46e5; color: white; border: none; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; }
        .control-button:hover { background-color: #4338ca; }
        .control-button:active { transform: scale(0.95); }
        .control-button.secondary { background-color: #64748b; }
        .control-button.secondary:hover { background-color: #475569; }
        .control-button:disabled { background-color: #9ca3af; cursor: not-allowed; opacity: 0.7; }
</style>
</head>
<body>
    <div class="device-screen">
        <div class="status-bar">
            <i class="fa-brands fa-bluetooth-b"></i>
            <span id="status-prompt"></span>
            <i class="fa-solid fa-battery-full"></i>
        </div>
        <div id="main-content" class="main-content">
            <div id="tare-indicator" class="tare-indicator">TARE</div>
            <!-- é£Ÿç‰©é€‰æ‹©ç•Œé¢ -->
            <div id="food-selection" class="food-selection">
                <div id="food-grid"></div>
                <div id="food-page-indicator" class="page-indicator-container"></div>
            </div>
            <!-- è¥å…»ä¿¡æ¯ç•Œé¢ -->
            <div id="nutrition-display" class="nutrition-display hidden">
                 <div id="nutrition-pages-container">
                    <!-- é¡µé¢1: é‡é‡å’Œæ ¸å¿ƒèƒ½é‡ -->
                    <div id="nutrition-page-1" class="nutrition-page">
                        <div class="weight-energy-display">
                            <div class="weight-section">
                                <span id="weight-value" class="weight-value">0.0</span>
                                <span id="weight-unit" class="weight-unit">g</span>
                            </div>
                            <div class="energy-section">
                                <div class="energy-chart-container">
                                    <div class="energy-semicircle-bg"></div>
                                    <div class="energy-value-container">
                                        <div id="energy-percentage-label" class="energy-percentage-label">0%</div>
                                        <div><span id="energy-value" class="energy-value-chart">0</span><span class="energy-unit-chart">kcal</span></div>
                                    </div>
                                    <div class="energy-name-label">èƒ½é‡</div>
                                </div>
                                <div class="fat-chart-container">
                                    <div class="fat-semicircle-bg"></div>
                                    <div class="fat-value-container">
                                        <div id="fat-percentage-label" class="fat-percentage-label">0%</div>
                                        <div><span id="fat-value" class="fat-value-chart">0.0</span><span class="fat-unit-chart">g</span></div>
                                    </div>
                                    <div class="fat-name-label">æ€»è„‚è‚ª</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- é¡µé¢2: ä¸»è¦è¥å…»ç´  (è„‚è‚ª) -->
                    <div id="nutrition-page-2" class="nutrition-page">
                        <div class="nutrition-section">
                            <div class="section-title">ä¸»è¦è¥å…»ç´ </div>
                            <div class="dv-explanation">*åŸºäºFDAæ¯æ—¥è¥å…»ç´ å‚è€ƒå€¼è®¡ç®—</div>
                            <div id="major-nutrients-fat" class="major-nutrients-container"></div>
                        </div>
                    </div>
                    <!-- é¡µé¢3: ä¸»è¦è¥å…»ç´  (èƒ†å›ºé†‡, é’ , ç¢³æ°´) -->
                    <div id="nutrition-page-3" class="nutrition-page">
                         <div class="nutrition-section">
                            <div class="section-title">ä¸»è¦è¥å…»ç´ </div>
                            <div class="dv-explanation">*åŸºäºFDAæ¯æ—¥è¥å…»ç´ å‚è€ƒå€¼è®¡ç®—</div>
                            <div id="major-nutrients-chol" class="major-nutrients-container"></div>
                        </div>
                    </div>
                    <!-- é¡µé¢4: ä¸»è¦è¥å…»ç´  (çº¤ç»´, ç³–, è›‹ç™½) -->
                    <div id="nutrition-page-4" class="nutrition-page">
                         <div class="nutrition-section">
                            <div class="section-title">ä¸»è¦è¥å…»ç´ </div>
                            <div class="dv-explanation">*åŸºäºFDAæ¯æ—¥è¥å…»ç´ å‚è€ƒå€¼è®¡ç®—</div>
                            <div id="major-nutrients-fiber" class="major-nutrients-container"></div>
                        </div>
                    </div>
                    <!-- ç»´ç”Ÿç´ é¡µé¢ -->
                    <div id="nutrition-page-5" class="nutrition-page">
                        <div class="nutrition-section vitamins-section" style="width: 100%;">
                            <div class="section-title">ç»´ç”Ÿç´ </div>
                            <div id="vitamins-grid-1" class="nutrients-grid"></div>
                        </div>
                    </div>
                     <div id="nutrition-page-6" class="nutrition-page">
                        <div class="nutrition-section vitamins-section" style="width: 100%;">
                            <div class="section-title">ç»´ç”Ÿç´ </div>
                            <div id="vitamins-grid-2" class="nutrients-grid"></div>
                        </div>
                    </div>
                     <div id="nutrition-page-7" class="nutrition-page">
                        <div class="nutrition-section vitamins-section" style="width: 100%;">
                            <div class="section-title">ç»´ç”Ÿç´ </div>
                            <div id="vitamins-grid-3" class="nutrients-grid"></div>
                        </div>
                    </div>
                    <!-- çŸ¿ç‰©è´¨é¡µé¢ -->
                    <div id="nutrition-page-8" class="nutrition-page">
                        <div class="nutrition-section minerals-section" style="width: 100%;">
                            <div class="section-title">çŸ¿ç‰©è´¨</div>
                            <div id="minerals-grid-1" class="nutrients-grid"></div>
                        </div>
                    </div>
                    <div id="nutrition-page-9" class="nutrition-page">
                        <div class="nutrition-section minerals-section" style="width: 100%;">
                            <div class="section-title">çŸ¿ç‰©è´¨</div>
                            <div id="minerals-grid-2" class="nutrients-grid"></div>
                        </div>
                    </div>
                    <div id="nutrition-page-10" class="nutrition-page">
                        <div class="nutrition-section minerals-section" style="width: 100%;">
                            <div class="section-title">çŸ¿ç‰©è´¨</div>
                            <div id="minerals-grid-3" class="nutrients-grid"></div>
                        </div>
                    </div>
                 </div>
                 <div id="nutrition-page-indicator" class="hidden"></div>
            </div>
        </div>
        <div id="hint-bar" class="hint-bar"></div>
    </div>
    <div class="interaction-controls">
        <button id="btn-rotate-left" class="control-button" title="æ¨¡æ‹Ÿå‘å·¦æ—‹è½¬">â† æ—‹è½¬</button>
        <button id="btn-rotate-right" class="control-button" title="æ¨¡æ‹Ÿå‘å³æ—‹è½¬">æ—‹è½¬ â†’</button>
        <button id="btn-short-press" class="control-button" title="æ¨¡æ‹ŸçŸ­æŒ‰">ç¡®è®¤é£Ÿç‰©</button>
        <button id="btn-long-press" class="control-button secondary" title="æ¨¡æ‹Ÿé•¿æŒ‰æ—‹é’®">é•¿æŒ‰ (è¿”å›/å…³æœº)</button>
        <button id="btn-return-index" class="control-button secondary" title="è¿”å›ç›®å½•é¡µé¢">è¿”å›ç›®å½•</button>
        <button id="btn-add-weight" class="control-button" style="background-color: #10b981;">æ¨¡æ‹ŸåŠ é‡</button>
    </div>

    <script>
        // --- çŠ¶æ€å˜é‡ ---
        let currentWeight = 0.0;
        let selectedFoodIndex = 0;
        let isFoodConfirmed = false;
        let nutritionCurrentPage = 0;
        
        // --- æ•°æ®åº“å’Œå¸¸é‡ ---
        const dailyValues = { kcal: 2000, f: 78, satFat: 20, cholesterol: 300, na: 2300, c: 275, fiber: 28, p: 50, vitA: 900, vitC: 90, vitD: 20, ca: 1300, fe: 18, k: 4700, vitB1: 1.2, vitB2: 1.3, vitB6: 1.7, vitB12: 2.4, vitE: 15, niacin: 16, phos: 1250, mg: 420, zn: 11, se: 55, cu: 0.9, mn: 2.3 };
        const foodDatabase = [
            { name: "é¸¡èƒ¸è‚‰", icon: "ğŸ—", kcal: 130, p: 27.0, f: 2.7, satFat: 0.6, transFat: 0.0, c: 0.0, fiber: 0.0, sugar: 0.0, ca: 13, fe: 0.7, zn: 0.9, se: 22.0, na: 45, k: 256, cholesterol: 60, vitA: 13, vitB1: 0.07, vitB2: 0.09, vitB6: 0.6, vitB12: 0.3, vitC: 0, vitD: 0.1, vitE: 0.13, niacin: 13.7, phos: 210, mg: 29, cu: 0.05, mn: 0.02 },
            { name: "é¸¡è›‹", icon: "ğŸ¥š", kcal: 143, p: 12.6, f: 9.9, satFat: 3.1, transFat: 0.0, c: 1.1, fiber: 0.0, sugar: 1.1, ca: 56, fe: 1.8, zn: 1.3, se: 30.8, na: 142, k: 126, cholesterol: 372, vitA: 160, vitB1: 0.04, vitB2: 0.5, vitB6: 0.14, vitB12: 1.1, vitC: 0, vitD: 2.0, vitE: 1.03, niacin: 0.07, phos: 198, mg: 10, cu: 0.07, mn: 0.03 },
            { name: "ç±³é¥­", icon: "ğŸš", kcal: 116, p: 2.7, f: 0.2, satFat: 0.1, transFat: 0.0, c: 25.1, fiber: 0.3, sugar: 0.1, ca: 3, fe: 0.1, zn: 0.4, se: 2.8, na: 1, k: 26, cholesterol: 0, vitA: 0, vitB1: 0.02, vitB2: 0.01, vitB6: 0.05, vitB12: 0, vitC: 0, vitD: 0, vitE: 0.02, niacin: 0.4, phos: 12, mg: 4, cu: 0.02, mn: 0.16 },
            { name: "ç‡•éº¦ç‰‡", icon: "ğŸŒ¾", kcal: 389, p: 16.9, f: 6.9, satFat: 1.2, transFat: 0.0, c: 66.3, fiber: 10.6, sugar: 0.6, ca: 54, fe: 4.7, zn: 4.0, se: 28.9, na: 2, k: 429, cholesterol: 0, vitA: 0, vitB1: 0.76, vitB2: 0.14, vitB6: 0.12, vitB12: 0, vitC: 0, vitD: 0, vitE: 0.42, niacin: 0.96, phos: 523, mg: 177, cu: 0.63, mn: 4.92 },
            { name: "åœŸè±†", icon: "ğŸ¥”", kcal: 77, p: 2.0, f: 0.1, satFat: 0.0, transFat: 0.0, c: 17.5, fiber: 2.2, sugar: 0.8, ca: 11, fe: 0.3, zn: 0.3, se: 0.4, na: 6, k: 379, cholesterol: 0, vitA: 0, vitB1: 0.08, vitB2: 0.03, vitB6: 0.30, vitB12: 0, vitC: 19.7, vitD: 0, vitE: 0.01, niacin: 1.06, phos: 57, mg: 23, cu: 0.11, mn: 0.15 },
            { name: "ç‰›å¥¶", icon: "ğŸ¥›", kcal: 54, p: 3.3, f: 1.0, satFat: 0.6, transFat: 0.0, c: 5.0, fiber: 0.0, sugar: 5.0, ca: 104, fe: 0.1, zn: 0.4, se: 1.5, na: 50, k: 150, cholesterol: 5, vitA: 46, vitB1: 0.04, vitB2: 0.18, vitB6: 0.04, vitB12: 0.45, vitC: 0, vitD: 1.2, vitE: 0.07, niacin: 0.1, phos: 93, mg: 12, cu: 0.01, mn: 0.003 },
            { name: "é¦™è•‰", icon: "ğŸŒ", kcal: 89, p: 1.1, f: 0.3, satFat: 0.1, transFat: 0.0, c: 22.8, fiber: 2.6, sugar: 12.2, ca: 5, fe: 0.3, zn: 0.2, se: 1.0, na: 1, k: 358, cholesterol: 0, vitA: 3, vitB1: 0.03, vitB2: 0.07, vitB6: 0.37, vitB12: 0, vitC: 8.7, vitD: 0, vitE: 0.10, niacin: 0.67, phos: 22, mg: 27, cu: 0.08, mn: 0.27 },
            { name: "ç‰›æ²¹æœ", icon: "ğŸ¥‘", kcal: 160, p: 2.0, f: 14.7, satFat: 2.1, transFat: 0.0, c: 8.5, fiber: 6.7, sugar: 0.7, ca: 12, fe: 0.6, zn: 0.6, se: 0.4, na: 7, k: 485, cholesterol: 0, vitA: 7, vitB1: 0.07, vitB2: 0.13, vitB6: 0.26, vitB12: 0, vitC: 10.0, vitD: 0, vitE: 2.07, niacin: 1.74, phos: 52, mg: 29, cu: 0.19, mn: 0.14 },
            { name: "è¥¿å…°èŠ±", icon: "ğŸ¥¦", kcal: 34, p: 2.8, f: 0.4, satFat: 0.1, transFat: 0.0, c: 7.0, fiber: 2.6, sugar: 1.7, ca: 47, fe: 0.7, zn: 0.4, se: 2.5, na: 33, k: 316, cholesterol: 0, vitA: 31, vitB1: 0.07, vitB2: 0.12, vitB6: 0.18, vitB12: 0, vitC: 89.2, vitD: 0, vitE: 0.78, niacin: 0.64, phos: 66, mg: 21, cu: 0.05, mn: 0.21 },
            { name: "æä»", icon: "ğŸŒ°", kcal: 579, p: 21.2, f: 49.9, satFat: 3.8, transFat: 0.0, c: 21.6, fiber: 12.5, sugar: 4.4, ca: 269, fe: 3.7, zn: 3.1, se: 4.1, na: 1, k: 733, cholesterol: 0, vitA: 0, vitB1: 0.21, vitB2: 1.14, vitB6: 0.14, vitB12: 0, vitC: 0, vitD: 0, vitE: 25.63, niacin: 3.6, phos: 481, mg: 270, cu: 1.03, mn: 2.18 },
            { name: "æ©„æ¦„æ²¹", icon: "ğŸ«’", kcal: 884, p: 0.0, f: 100.0, satFat: 14.0, transFat: 0.0, c: 0.0, fiber: 0.0, sugar: 0.0, ca: 1, fe: 0.6, zn: 0.0, se: 0.0, na: 2, k: 1, cholesterol: 0, vitA: 0, vitB1: 0.0, vitB2: 0.0, vitB6: 0.0, vitB12: 0, vitC: 0, vitD: 0, vitE: 14.35, niacin: 0.0, phos: 0, mg: 0, cu: 0.0, mn: 0.0 },
            { name: "é¢ç²‰", icon: "ğŸ", kcal: 333, p: 10.3, f: 1.0, satFat: 0.2, transFat: 0.0, c: 72.6, fiber: 2.7, sugar: 0.3, ca: 15, fe: 1.2, zn: 0.7, se: 33.9, na: 2, k: 107, cholesterol: 0, vitA: 0, vitB1: 0.12, vitB2: 0.04, vitB6: 0.04, vitB12: 0, vitC: 0, vitD: 0, vitE: 0.06, niacin: 1.0, phos: 108, mg: 22, cu: 0.14, mn: 0.68 }
        ];
        const nutrientsMap = {
            'f': { name: 'æ€»è„‚è‚ª', unit: 'g', precision: 1, showDV: true }, 'satFat': { name: 'é¥±å’Œè„‚è‚ª', unit: 'g', precision: 1, showDV: true }, 'transFat': { name: 'åå¼è„‚è‚ª', unit: 'g', precision: 1, showDV: false }, 'cholesterol': { name: 'èƒ†å›ºé†‡', unit: 'mg', precision: 0, showDV: true }, 'na': { name: 'é’ ', unit: 'mg', precision: 0, showDV: true }, 'c': { name: 'æ€»ç¢³æ°´åŒ–åˆç‰©', unit: 'g', precision: 1, showDV: true }, 'fiber': { name: 'è†³é£Ÿçº¤ç»´', unit: 'g', precision: 1, showDV: true }, 'sugar': { name: 'ç³–', unit: 'g', precision: 1, showDV: false }, 'p': { name: 'è›‹ç™½è´¨', unit: 'g', precision: 1, showDV: false },
            'vitA': { name: 'ç»´ç”Ÿç´ A', unit: 'Âµg', precision: 0, showDV: true }, 'vitC': { name: 'ç»´ç”Ÿç´ C', unit: 'mg', precision: 0, showDV: true }, 'vitD': { name: 'ç»´ç”Ÿç´ D', unit: 'Âµg', precision: 0, showDV: true }, 'vitE': { name: 'ç»´ç”Ÿç´ E', unit: 'mg', precision: 1, showDV: true }, 'vitB1': { name: 'ç»´ç”Ÿç´ B1', unit: 'mg', precision: 2, showDV: true }, 'vitB2': { name: 'ç»´ç”Ÿç´ B2', unit: 'mg', precision: 2, showDV: true }, 'vitB6': { name: 'ç»´ç”Ÿç´ B6', unit: 'mg', precision: 2, showDV: true }, 'vitB12': { name: 'ç»´ç”Ÿç´ B12', unit: 'Âµg', precision: 1, showDV: true }, 'niacin': { name: 'çƒŸé…¸', unit: 'mg', precision: 1, showDV: true },
            'ca': { name: 'é’™', unit: 'mg', precision: 0, showDV: true }, 'fe': { name: 'é“', unit: 'mg', precision: 1, showDV: true }, 'k': { name: 'é’¾', unit: 'mg', precision: 0, showDV: true }, 'phos': { name: 'ç£·', unit: 'mg', precision: 0, showDV: true }, 'mg': { name: 'é•', unit: 'mg', precision: 0, showDV: true }, 'zn': { name: 'é”Œ', unit: 'mg', precision: 1, showDV: true }, 'se': { name: 'ç¡’', unit: 'Âµg', precision: 0, showDV: true }, 'cu': { name: 'é“œ', unit: 'Âµg', precision: 2, showDV: true }, 'mn': { name: 'é”°', unit: 'mg', precision: 2, showDV: true }
        };
        const nutrientIcons = {
            'f': `<svg width="1.5em" height="1.5em" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><g><path d="M24 6C24 6 36 18 36 28C36 36 24 42 24 42C24 42 12 36 12 28C12 18 24 6 24 6Z" fill="#FFD600" stroke="#FF9800" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><ellipse cx="24" cy="28" rx="10" ry="7" fill="#FFF8E1"/></g></svg>`,
            'satFat': `<svg width="1.5em" height="1.5em" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><g><ellipse cx="24" cy="28" rx="10" ry="7" fill="#FFECB3" stroke="#FFB300" stroke-width="2"/><ellipse cx="24" cy="28" rx="5" ry="3.5" fill="#FFB300"/></g></svg>`,
            'transFat': `<svg width="1.5em" height="1.5em" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><g><circle cx="24" cy="24" r="16" fill="#E57373"/><path d="M16 16L32 32" stroke="#fff" stroke-width="3" stroke-linecap="round"/><path d="M32 16L16 32" stroke="#fff" stroke-width="3" stroke-linecap="round"/></g></svg>`,
            'cholesterol': `<svg width="1.5em" height="1.5em" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><g><ellipse cx="24" cy="32" rx="12" ry="8" fill="#FFF9C4" stroke="#FFD600" stroke-width="2"/><ellipse cx="24" cy="28" rx="6" ry="4" fill="#FFD600"/></g></svg>`,
            'na': `<svg width="1.5em" height="1.5em" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><g><rect x="10" y="18" width="28" height="12" rx="6" fill="#B3E5FC" stroke="#0288D1" stroke-width="2"/><rect x="18" y="22" width="12" height="4" rx="2" fill="#0288D1"/></g></svg>`,
            'c': `<svg width="1.5em" height="1.5em" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><g><rect x="8" y="20" width="32" height="16" rx="8" fill="#FFF3E0" stroke="#FF9800" stroke-width="2"/><rect x="16" y="28" width="16" height="4" rx="2" fill="#FF9800"/></g></svg>`,
            'fiber': `<svg width="1.5em" height="1.5em" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><g><path d="M24 8C24 8 32 16 32 24C32 32 24 40 24 40C24 40 16 32 16 24C16 16 24 8 24 8Z" fill="#C8E6C9" stroke="#388E3C" stroke-width="2"/><ellipse cx="24" cy="24" rx="6" ry="4" fill="#388E3C"/></g></svg>`,
            'sugar': `<svg width="1.5em" height="1.5em" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><g><rect x="14" y="20" width="20" height="12" rx="6" fill="#FFF" stroke="#E91E63" stroke-width="2"/><circle cx="24" cy="26" r="3" fill="#E91E63"/></g></svg>`,
            'p': `<svg width="1.5em" height="1.5em" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><g><rect x="12" y="16" width="24" height="16" rx="8" fill="#BBDEFB" stroke="#1976D2" stroke-width="2"/><rect x="20" y="24" width="8" height="4" rx="2" fill="#1976D2"/></g></svg>`,
        };
        
        const vitaminKeys = Object.keys(nutrientsMap).filter(k => ['vitA', 'vitC', 'vitD', 'vitE', 'vitB1', 'vitB2', 'vitB6', 'vitB12', 'niacin'].includes(k));
        const mineralKeys = Object.keys(nutrientsMap).filter(k => ['ca', 'fe', 'k', 'phos', 'mg', 'zn', 'se', 'cu', 'mn'].includes(k));
        const gridPageSize = 4; // 2x2 grid
        const numVitaminPages = Math.ceil(vitaminKeys.length / gridPageSize);
        const numMineralPages = Math.ceil(mineralKeys.length / gridPageSize);
        const nutritionTotalPages = 4 + numVitaminPages + numMineralPages; // 4 fixed pages + vitamin pages + mineral pages
        
        let foodItemElements = [];
        let tareTimeout = null;
        
        // --- Long Press State ---
        let longPressTimer = null;
        let longPressStartTime = 0;
        let currentLongPressDuration = 0;
        let longPressActive = false;
        const LONG_PRESS_RETURN_DURATION = 1000;
        const LONG_PRESS_POWER_OFF_DURATION = 5000;
        const LONG_PRESS_ACTION_NONE = 0;
        const LONG_PRESS_ACTION_RETURN = 1;
        let currentLongPressAction = LONG_PRESS_ACTION_NONE;

        window.addEventListener('load', () => {
            // --- DOM å…ƒç´ è·å– ---
            const statusPrompt = document.getElementById('status-prompt');
            const foodSelection = document.getElementById('food-selection');
            const foodGrid = document.getElementById('food-grid');
            const foodPageIndicator = document.getElementById('food-page-indicator');
            const nutritionDisplay = document.getElementById('nutrition-display');
            const hintBar = document.getElementById('hint-bar');
            const nutritionPageIndicator = document.getElementById('nutrition-page-indicator');
            const btnRotateLeft = document.getElementById('btn-rotate-left');
            const btnRotateRight = document.getElementById('btn-rotate-right');
            const btnShortPress = document.getElementById('btn-short-press');
            const btnLongPress = document.getElementById('btn-long-press');
            const btnReturnIndex = document.getElementById('btn-return-index');
            const btnAddWeight = document.getElementById('btn-add-weight');

            // --- æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ---
            function calculateSingleNutrient(nutrientKey, weightGrams) {
                if (weightGrams <= 0 || selectedFoodIndex < 0) return 0;
                const food = foodDatabase[selectedFoodIndex];
                const valuePer100g = food[nutrientKey] || 0;
                const calculatedValue = (valuePer100g / 100.0) * weightGrams;
                const nutrientInfo = nutrientsMap[nutrientKey];
                const precision = nutrientInfo ? nutrientInfo.precision : 1;
                return nutrientKey === 'kcal' ? Math.round(calculatedValue) : parseFloat(calculatedValue.toFixed(precision));
            }

            function calculateDVPercentage(nutrientKey, value) {
                const dv = dailyValues[nutrientKey];
                if (!dv || value <= 0) return 0;
                let adjustedValue = (nutrientKey === 'cu') ? value / 1000 : value;
                return Math.round((adjustedValue / dv) * 100);
            }

            function getDVClass(percentage) {
                if (percentage >= 20) return 'dv-high';
                if (percentage >= 10) return 'dv-medium';
                if (percentage >= 5) return 'dv-low';
                return 'dv-minimal';
            }

            function populateNutrientDisplays() {
                // Page 1: æ ¸å¿ƒèƒ½é‡
                const caloriesValue = calculateSingleNutrient('kcal', currentWeight);
                const fatValue = calculateSingleNutrient('f', currentWeight);
                updateChart('energy', caloriesValue);
                updateChart('fat', fatValue);
                document.getElementById('weight-value').textContent = currentWeight.toFixed(1);

                // Page 2-4: ä¸»è¦è¥å…»ç´ 
                populateMajorNutrients('major-nutrients-fat', ['f', 'satFat', 'transFat']);
                populateMajorNutrients('major-nutrients-chol', ['cholesterol', 'na', 'c']);
                populateMajorNutrients('major-nutrients-fiber', ['fiber', 'sugar', 'p']);

                // Page 5-7: ç»´ç”Ÿç´ åˆ†é¡µ
                for (let i = 0; i < numVitaminPages; i++) {
                    const start = i * gridPageSize;
                    const end = start + gridPageSize;
                    const pageKeys = vitaminKeys.slice(start, end);
                    populateGridNutrients(`vitamins-grid-${i+1}`, pageKeys);
                }

                // Page 8-10: çŸ¿ç‰©è´¨åˆ†é¡µ
                for (let i = 0; i < numMineralPages; i++) {
                    const start = i * gridPageSize;
                    const end = start + gridPageSize;
                    const pageKeys = mineralKeys.slice(start, end);
                    populateGridNutrients(`minerals-grid-${i+1}`, pageKeys);
                }
            }
            
            function updateChart(type, value) {
                const valueEl = document.getElementById(`${type}-value`);
                const percentageEl = document.getElementById(`${type}-percentage-label`);
                const semicircleEl = document.querySelector(`.${type}-semicircle-bg`);
                
                if (!valueEl || !percentageEl || !semicircleEl) return;

                const dvKey = type === 'energy' ? 'kcal' : 'f';
                const dvPercentage = calculateDVPercentage(dvKey, value);

                valueEl.textContent = (type === 'fat') ? value.toFixed(1) : value;
                percentageEl.textContent = `${dvPercentage}%`;
                percentageEl.className = `energy-percentage-label ${getDVClass(dvPercentage)}`;
                semicircleEl.className = `${type}-semicircle-bg ${getDVClass(dvPercentage).replace('dv-', 'color-')}`;
            }

            function populateMajorNutrients(containerId, keys) {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = '';
                keys.forEach(key => {
                    const nutrient = nutrientsMap[key];
                    if (!nutrient) return;
                    const value = calculateSingleNutrient(key, currentWeight);
                    const dvPercentage = calculateDVPercentage(key, value);
                    let dvHtml = '';
                    if (nutrient.showDV && value > 0) {
                        dvHtml = `<span class="dv-percentage ${getDVClass(dvPercentage)}">${dvPercentage}%</span>`;
                    }
                    const iconHtml = nutrientIcons[key] || '';
                    container.innerHTML += `
                        <div class="major-nutrient-item">
                            <div class="nutrient-name-container">
                                ${iconHtml}
                                <span class="nutrient-name">${nutrient.name}</span>
                            </div>
                            <div class="nutrient-value-container">
                                <span class="nutrient-value">${value}</span>
                                <span class="nutrient-unit">${nutrient.unit}</span>
                                ${dvHtml}
                            </div>
                        </div>`;
                });
            }

            function populateGridNutrients(containerId, keys) {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = '';
                keys.forEach(key => {
                    const nutrient = nutrientsMap[key];
                    if (!nutrient) return;
                    const value = calculateSingleNutrient(key, currentWeight);

                    container.innerHTML += `
                        <div class="nutrient-mini-card">
                            <span class="mini-name">${nutrient.name}</span>
                            <div class="mini-value-container">
                                <span class="mini-value">${value}</span>
                                <span class="mini-unit">${nutrient.unit}</span>
                            </div>
                        </div>`;
                });
            }
            
            function showCurrentNutritionPage() {
                document.querySelectorAll('.nutrition-page').forEach((page, index) => {
                    page.classList.toggle('visible', index === nutritionCurrentPage);
                });
                updateNutritionPageIndicator();
            }
            
            function updateNutritionPageIndicator() {
                const indicator = document.getElementById('nutrition-page-indicator');
                if (!indicator) return;
                indicator.innerHTML = '';
                for (let i = 0; i < nutritionTotalPages; i++) {
                    const dot = document.createElement('div');
                    dot.className = `page-dot ${i === nutritionCurrentPage ? 'active' : ''}`;
                    indicator.appendChild(dot);
                }
            }

            function updateUI() {
                foodSelection.classList.toggle('hidden', isFoodConfirmed);
                nutritionDisplay.classList.toggle('hidden', !isFoodConfirmed);
                nutritionPageIndicator.classList.toggle('hidden', !isFoodConfirmed);

                if (isFoodConfirmed) {
                    const food = foodDatabase[selectedFoodIndex];
                    statusPrompt.textContent = food.name;
                    hintBar.textContent = "æ—‹è½¬ç¿»é¡µ | çŸ­æŒ‰å»çš®";
                    btnShortPress.textContent = "å»çš® (çŸ­æŒ‰)";
                    populateNutrientDisplays();
                    showCurrentNutritionPage();
                } else {
                    statusPrompt.textContent = "é€‰æ‹©é£Ÿç‰©";
                    hintBar.textContent = "æ—‹è½¬é€‰æ‹© | çŸ­æŒ‰ç¡®è®¤";
                    btnShortPress.textContent = "ç¡®è®¤é£Ÿç‰© (çŸ­æŒ‰)";
                    updateFoodSelectionVisuals();
                }
            }
            
            function updateFoodSelectionVisuals() {
                const pageSize = 6;
                const currentPage = Math.floor(selectedFoodIndex / pageSize);
                const totalPages = Math.ceil(foodDatabase.length / pageSize);
                
                const start = currentPage * pageSize;
                const end = start + pageSize;
                foodGrid.innerHTML = '';
                foodDatabase.slice(start, end).forEach((food, index) => {
                    const item = document.createElement('div');
                    item.className = 'food-item';
                    if ((start + index) === selectedFoodIndex) {
                        item.classList.add('selected');
                    }
                    item.innerHTML = `<span style="font-size: 2.5em;">${food.icon}</span><span>${food.name}</span>`;
                    foodGrid.appendChild(item);
                });

                foodPageIndicator.innerHTML = '';
                for (let i = 0; i < totalPages; i++) {
                    const dot = document.createElement('div');
                    dot.className = `page-dot ${i === currentPage ? 'active' : ''}`;
                    foodPageIndicator.appendChild(dot);
                }
            }

            // --- äº‹ä»¶å¤„ç†å‡½æ•° ---
            function handleShortPress() {
                if (isFoodConfirmed) {
                    currentWeight = 0.0;
                    const tareIndicatorEl = document.getElementById('tare-indicator');
                    if (tareIndicatorEl) {
                        tareIndicatorEl.classList.add('visible');
                        setTimeout(() => tareIndicatorEl.classList.remove('visible'), 1000);
                    }
                } else {
                    isFoodConfirmed = true;
                    nutritionCurrentPage = 0;
                }
                updateUI();
            }

            function handleRotate(direction) {
                if (isFoodConfirmed) {
                    nutritionCurrentPage = (nutritionCurrentPage + direction + nutritionTotalPages) % nutritionTotalPages;
                    showCurrentNutritionPage();
                } else {
                    const oldPage = Math.floor(selectedFoodIndex / 6);
                    selectedFoodIndex = (selectedFoodIndex + direction + foodDatabase.length) % foodDatabase.length;
                    const newPage = Math.floor(selectedFoodIndex / 6);
                    if (oldPage !== newPage) {
                        updateFoodSelectionVisuals();
                    } else {
                         foodGrid.querySelectorAll('.food-item').forEach((item, index) => {
                             if(item) item.classList.toggle('selected', (oldPage * 6 + index) === selectedFoodIndex);
                         });
                    }
                }
                updateUI();
            }
            
            function simulateAddWeight() {
                if (isFoodConfirmed) {
                    currentWeight += Math.random() * 50 + 20;
                    updateUI();
                }
            }

            // --- Long Press Functions ---
            function simulateDirectPowerOff() {
                disableAllButtons();
                const deviceScreen = document.querySelector('.device-screen');
                if (deviceScreen) {
                    deviceScreen.innerHTML = '';
                    deviceScreen.style.backgroundColor = '#000000';
                }
                if (longPressActive && longPressTimer) {
                    cancelAnimationFrame(longPressTimer);
                    longPressTimer = null;
                    longPressActive = false;
                }
            }

            function disableAllButtons() {
                [btnRotateLeft, btnRotateRight, btnShortPress, btnLongPress, btnReturnIndex, btnAddWeight].forEach(btn => {
                    if(btn) btn.disabled = true;
                });
            }

            function startLongPress() {
                if (longPressActive) return;
                longPressActive = true;
                longPressStartTime = Date.now();
                currentLongPressDuration = 0;
                currentLongPressAction = LONG_PRESS_ACTION_NONE;
                if (hintBar) hintBar.classList.add('long-press-active');
                updateLongPressHintText();
                longPressTimer = requestAnimationFrame(updateLongPressHintLoop);
            }

            function updateLongPressHintLoop() {
                if (!longPressActive) return;
                updateLongPressHintText();
                longPressTimer = requestAnimationFrame(updateLongPressHintLoop);
            }

            function updateLongPressHintText() {
                currentLongPressDuration = Date.now() - longPressStartTime;
                if (currentLongPressDuration >= LONG_PRESS_POWER_OFF_DURATION) {
                    if (longPressActive) simulateDirectPowerOff();
                    return;
                }
                
                const remainingSeconds = Math.ceil((LONG_PRESS_POWER_OFF_DURATION - currentLongPressDuration) / 1000);
                if (hintBar) {
                    hintBar.innerHTML = `é•¿æŒ‰è¿”å›  | ç»§ç»­æŒ‰ä½<span class="blink-text-inline">${remainingSeconds}s</span>å…³æœº`;
                }
                
                currentLongPressAction = (currentLongPressDuration >= LONG_PRESS_RETURN_DURATION) ? LONG_PRESS_ACTION_RETURN : LONG_PRESS_ACTION_NONE;
            }

            function cancelLongPress() {
                if (!longPressActive) return;
                longPressActive = false;
                if (longPressTimer) {
                    cancelAnimationFrame(longPressTimer);
                    longPressTimer = null;
                }
                if (hintBar) {
                    hintBar.classList.remove('long-press-active');
                }
                // Restore hint text by calling updateUI
                updateUI();
                
                if (currentLongPressAction === LONG_PRESS_ACTION_RETURN) {
                    window.location.href = 'main_menu.html';
                }
                currentLongPressAction = LONG_PRESS_ACTION_NONE;
            }

            // --- åˆå§‹åŒ–å’Œäº‹ä»¶ç»‘å®š ---
            btnRotateLeft.addEventListener('click', () => handleRotate(-1));
            btnRotateRight.addEventListener('click', () => handleRotate(1));
            btnShortPress.addEventListener('click', handleShortPress);
            btnAddWeight.addEventListener('click', simulateAddWeight);
            btnLongPress.addEventListener('mousedown', startLongPress);
            btnLongPress.addEventListener('mouseup', cancelLongPress);
            btnLongPress.addEventListener('mouseleave', cancelLongPress);
            btnReturnIndex.addEventListener('click', () => { window.location.href = 'index.html'; });

            updateUI();
        });
    </script>
</body>
</html>
